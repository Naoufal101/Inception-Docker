name: inception

services:
  mariadb:
      build:
        context: requirements/mariadb
      env_file: 
        - .env
      volumes:
        - data_base:/var/lib/mysql/
      secrets:
        - my_secret
        - my_other_secret
      healthcheck:
        test: ["CMD", "mariadb-admin", "ping", "-h", "localhost"]
        interval: 10s
        timeout: 5s
        retries: 5

  wordpress:
      build:
        context: requirements/wordpress
      env_file: 
        - .env
      secrets:
        - my_other_secret
      volumes:
        - wordpress_files:/var/www/wordpress
      depends_on:
        mariadb:
          condition: service_healthy
      healthcheck:
        test: ["CMD-SHELL", "SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect 127.0.0.1:9000 | grep 'pong'"]
        interval: 10s
        timeout: 5s
        retries: 5
        start_period: 30s

  nginx:
      build:
        context: requirements/nginx
      env_file: 
        - .env
      ports:
        - 443:443
      volumes:
        - type: volume
          source: wordpress_files
          target: /var/www/wordpress
        - type: bind
          source: ./requirements/nginx/conf
          target: /etc/inception/
      depends_on:
        wordpress:
          condition: service_healthy

secrets:
  my_secret:
    file: ../secrets/db_root_password.txt
  my_other_secret:
    file: ../secrets/db_password.txt

volumes:
  wordpress_files:
    name: wordpress_files
    driver_opts:
      type: none
      o: bind
      device: /home/naoufal/data/wordpress_files
  data_base:
    name: data_base
    driver_opts:
      type: none
      o: bind
      device: /home/naoufal/data/data_base
